name: Publish Flatpak repo to GitHub Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder xz-utils imagemagick inkscape rsync
          flatpak --version

      # ðŸ‘‰ Ajoute Flathub en user et en system (ceinture + bretelles)
      - name: Add Flathub remotes
        run: |
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo || true
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo || true
          flatpak remotes

      # ðŸ‘‰ PrÃ©-installe les runtimes GNOME 47 cÃ´tÃ© utilisateur
      - name: Install GNOME 47 SDK/Platform (user)
        run: |
          flatpak install -y --user --noninteractive flathub org.gnome.Sdk//47 org.gnome.Platform//47

      # Build & export vers repo/  (ton script utilise --install-deps-from=flathub)
      - name: Build & export repo
        run: |
          bash scripts/build_and_export.sh

      - name: Make .flatpakref
        env:
          APP_ID: io.reaven.LSFGVKLauncher
          HOMEPAGE: https://0xREAVEN.github.io/lsfgvk-launcher
          ICON_URL: https://0xREAVEN.github.io/lsfgvk-launcher/icons/io.reaven.LSFGVKLauncher.png
          REPO_URL: https://0xREAVEN.github.io/lsfgvk-launcher/repo
        run: |
          bash scripts/make_flatpakref.sh

      - name: Copy web assets
        run: |
          mkdir -p web/repo web/icons
          rsync -a repo/ web/repo/
          if [ -f icons/hicolor/128x128/apps/io.reaven.LSFGVKLauncher.png ]; then
            cp icons/hicolor/128x128/apps/io.reaven.LSFGVKLauncher.png web/icons/io.reaven.LSFGVKLauncher.png
          else
            inkscape icons/io.reaven.LSFGVKLauncher.svg --export-type=png \
              --export-filename=web/icons/io.reaven.LSFGVKLauncher.png --export-width=128 --export-height=128
          fi
          echo "<html><body><h1>Reaven Flatpak Repo</h1>
          <p><a href=\"io.reaven.LSFGVKLauncher.flatpakref\">Install LSFG-VK Launcher</a></p>
          </body></html>" > web/index.html

      # DÃ©ploiement sur gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: web
          publish_branch: gh-pages
