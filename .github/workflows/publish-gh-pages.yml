name: Publish Flatpak repo to GitHub Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      APP_ID: io.reaven.LSFGVKLauncher
      REPO_URL: https://0xreaven.github.io/lsfgvk-launcher/repo
    steps:
      - uses: actions/checkout@v4

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder xz-utils imagemagick inkscape rsync
          flatpak --version

      - name: Add Flathub remote (user)
        run: |
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak remotes --user

      - name: Install GNOME 47 SDK/Platform (user)
        run: |
          flatpak install -y --user --noninteractive flathub org.gnome.Sdk//47 org.gnome.Platform//47

      - name: Build & export repo (default-branch=stable)
        run: bash scripts/build_and_export.sh

      - name: Prepare web dir (repo + icons)
        run: |
          set -e
          mkdir -p web/repo web/icons
          rsync -a repo/ web/repo/
          if [ -f icons/hicolor/128x128/apps/${APP_ID}.png ]; then
            cp icons/hicolor/128x128/apps/${APP_ID}.png web/icons/${APP_ID}.png
          else
            inkscape icons/${APP_ID}.svg --export-type=png \
              --export-filename=web/icons/${APP_ID}.png --export-width=128 --export-height=128
          fi

      - name: Create flatpakref files (unsigned repo, force NoGPGVerify)
        run: |
          printf '%s\n' \
            '[Flatpak Ref]' \
            'Title=LSFG-VK Launcher' \
            'Name='${APP_ID} \
            'Branch=stable' \
            'Url='${REPO_URL} \
            'IsRuntime=false' \
            'RuntimeRepo=https://flathub.org/repo/flathub.flatpakrepo' \
            'NoGPGVerify=true' \
            > web/${APP_ID}.flatpakref
          cp web/${APP_ID}.flatpakref web/lsfgvk-launcher.flatpakref

      - name: Keep custom index.html (create default if missing)
        run: |
          if [ ! -f web/index.html ]; then
            printf '%s\n' \
              '<!doctype html><meta charset="utf-8"><title>LSFG-VK Launcher</title>' \
              '<p><a href="lsfgvk-launcher.flatpakref">Install .flatpakref</a></p>' \
              > web/index.html
          fi
          echo "=== WEB TREE ==="; ls -l web

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: web
          publish_branch: gh-pages
