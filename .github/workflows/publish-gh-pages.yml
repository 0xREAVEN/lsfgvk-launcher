name: Publish Flatpak repo to GitHub Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder xz-utils imagemagick inkscape rsync
          flatpak --version

      - name: Add Flathub remote (user)
        run: |
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak remotes --user

      - name: Install GNOME 47 SDK/Platform (user)
        run: |
          flatpak install -y --user --noninteractive flathub org.gnome.Sdk//47 org.gnome.Platform//47

      - name: Build & export repo
        run: |
          bash scripts/build_and_export.sh

      - name: Make .flatpakref (canonical)
        env:
          APP_ID: io.reaven.LSFGVKLauncher
          HOMEPAGE: https://0xreaven.github.io/lsfgvk-launcher
          ICON_URL: https://0xreaven.github.io/lsfgvk-launcher/icons/io.reaven.LSFGVKLauncher.png
          REPO_URL: https://0xreaven.github.io/lsfgvk-launcher/repo
        run: |
          bash scripts/make_flatpakref.sh

      - name: Copy web assets + friendly alias
        run: |
          mkdir -p web/repo web/icons
          rsync -a repo/ web/repo/
          # icône
          if [ -f icons/hicolor/128x128/apps/io.reaven.LSFGVKLauncher.png ]; then
            cp icons/hicolor/128x128/apps/io.reaven.LSFGVKLauncher.png web/icons/io.reaven.LSFGVKLauncher.png
          else
            inkscape icons/io.reaven.LSFGVKLauncher.svg --export-type=png \
              --export-filename=web/icons/io.reaven.LSFGVKLauncher.png --export-width=128 --export-height=128
          fi
          # alias .flatpakref simple
          cat > web/lsfgvk-launcher.flatpakref <<'EOF'
[Flatpak Ref]
Title=LSFG-VK Launcher
Name=io.reaven.LSFGVKLauncher
Branch=stable
Url=https://0xreaven.github.io/lsfgvk-launcher/repo
IsRuntime=false
RuntimeRepo=https://flathub.org/repo/flathub.flatpakrepo
EOF
          # page d’accueil avec bouton 1-clic
          cat > web/index.html <<'EOF'
<!doctype html><meta charset="utf-8">
<title>Reaven Flatpak Repo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;max-width:720px;margin:5rem auto;padding:0 1rem;line-height:1.5}
a.button{display:inline-block;padding:.9rem 1.1rem;border-radius:10px;text-decoration:none;border:1px solid #ccc}
h1{margin-bottom:.3rem}
small{color:#666}
</style>
<h1>LSFG-VK Launcher</h1>
<p>One-click install (Flatpak ref):</p>
<p><a class="button" href="lsfgvk-launcher.flatpakref">Install .flatpakref</a></p>
<p><small>Repo URL: <code>https://0xreaven.github.io/lsfgvk-launcher/repo</code></small></p>
EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: web
          publish_branch: gh-pages
